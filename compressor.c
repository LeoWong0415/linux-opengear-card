
#include "compressor.h"


//Global variables
extern int fd;
unsigned long min_gain_lk[801]={1,
1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,
2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,
2,2,2,2,2,2,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,
3,3,3,3,3,3,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,5,5,5,
5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,6,6,6,6,6,6,6,6,6,6,6,6,6,6,7,
7,7,7,7,7,7,7,7,7,7,7,7,8,8,8,8,8,8,8,8,8,8,8,9,9,9,9,9,9,9,
9,9,10,10,10,10,10,10,10,10,10,11,11,11,11,11,11,11,11,12,12,12,12,12,12,12,13,13,13,13,
13,13,13,14,14,14,14,14,14,15,15,15,15,15,15,16,16,16,16,16,17,17,17,17,17,18,18,18,18,18,
19,19,19,19,19,20,20,20,20,21,21,21,21,22,22,22,22,23,23,23,23,24,24,24,24,25,25,25,26,26,
26,27,27,27,27,28,28,28,29,29,29,30,30,30,31,31,32,32,32,33,33,33,34,34,35,35,35,36,36,37,
37,37,38,38,39,39,40,40,41,41,42,42,43,43,43,44,45,45,46,46,47,47,48,48,49,49,50,51,51,52,
52,53,54,54,55,55,56,57,57,58,59,59,60,61,61,62,63,64,64,65,66,67,67,68,69,70,71,71,72,73,
74,75,76,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,100,101,102,103,
104,106,107,108,109,111,112,113,114,116,117,118,120,121,123,124,125,127,128,130,131,133,134,136,138,139,141,142,144,146,
147,149,151,153,154,156,158,160,162,163,165,167,169,171,173,175,177,179,181,183,186,188,190,192,194,197,199,201,203,206,
208,211,213,215,218,220,223,226,228,231,234,236,239,242,245,247,250,253,256,259,262,265,268,271,274,278,281,284,287,291,
294,297,301,304,308,311,315,319,322,326,330,334,338,341,345,349,354,358,362,366,370,374,379,383,388,392,397,401,406,411,
415,420,425,430,435,440,445,450,455,461,466,471,477,482,488,494,499,505,511,517,523,529,535,541,548,554,560,567,573,580,
587,593,600,607,614,621,629,636,643,651,658,666,674,681,689,697,705,713,722,730,739,747,756,765,773,782,791,801,810,819,
829,838,848,858,868,878,888,898,909,919,930,941,951,962,974,985,996,1008,1020,1031,1043,1055,1068,1080,1092,1105,1118,1131,1144,1157,
1171,1184,1198,1212,1226,1240,1254,1269,1283,1298,1313,1329,1344,1360,1375,1391,1407,1424,1440,1457,1474,1491,1508,1525,1543,1561,1579,1597,1616,1635,
1653,1673,1692,1712,1731,1751,1772,1792,1813,1834,1855,1877,1898,1920,1943,1965,1988,2011,2034,2058,2082,2106,2130,2155,2180,2205,2230,2256,2282,2309,
2336,2363,2390,2418,2446,2474,2503,2532,2561,2591,2621,2651,2682,2713,2744,2776,2808,2840,2873,2907,2940,2974,3009,3044,3079,3115,3151,3187,3224,3261,
3299,3337,3376,3415,3455,3495,3535,3576,3617,3659,3702,3744,3788,3832,3876,3921,3966,4012,4059,4106,4153,4201,4250,4299,4349,4399,4450,4502,4554,4607,
4660,4714,4769,4824,4880,4936,4993,5051,5110,5169,5229,5289,5350,5412,5475,5538,5603,5667,5733,5799,5867,5935,6003,6073,6143,6214,6286,6359,6433,6507,
6582,6659,6736,6814,6893,6973,7053,7135,7218,7301,7386,7471,7558,7645,7734,7823,7914,8006,8098,8192};

unsigned long gain_lkup[401]={
8192,
8287,8383,8480,8578,8677,8778,8880,8982,9086,9192,9298,9406,9515,9625,9736,9849,9963,10078,10195,10313,10433,10553,10676,10799,10924,11051,11179,11308,11439,11572,
11705,11841,11978,12117,12257,12399,12543,12688,12835,12983,13134,13286,13440,13595,13753,13912,14073,14236,14401,14568,14736,14907,15080,15254,15431,15610,15790,15973,16158,16345,
16534,16726,16920,17116,17314,17514,17717,17922,18130,18340,18552,18767,18984,19204,19426,19651,19879,20109,20342,20577,20816,21057,21301,21547,21797,22049,22304,22563,22824,23088,
23356,23626,23900,24176,24456,24739,25026,25316,25609,25905,26205,26509,26816,27126,27440,27758,28080,28405,28734,29066,29403,29743,30088,30436,30789,31145,31506,31871,32240,32613,
32991,33373,33759,34150,34545,34945,35350,35759,36173,36592,37016,37445,37878,38317,38761,39209,39663,40123,40587,41057,41533,42014,42500,42992,43490,43994,44503,45018,45540,46067,
46600,47140,47686,48238,48797,49362,49933,50511,51096,51688,52287,52892,53504,54124,54751,55385,56026,56675,57331,57995,58666,59346,60033,60728,61431,62143,62862,63590,64327,65071,
65825,66587,67358,68138,68927,69725,70533,71349,72176,73011,73857,74712,75577,76452,77337,78233,79139,80055,80982,81920,82869,83828,84799,85781,86774,87779,88795,89823,90864,91916,
92980,94057,95146,96248,97362,98490,99630,100784,101951,103131,104325,105533,106755,107992,109242,110507,111787,113081,114391,115715,117055,118410,119782,121169,122572,123991,125427,126879,128348,129834,
131338,132859,134397,135953,137528,139120,140731,142361,144009,145677,147364,149070,150796,152542,154309,156095,157903,159731,161581,163452,165345,167259,169196,171155,173137,175142,177170,179221,181297,183396,
185520,187668,189841,192039,194263,196512,198788,201090,203418,205774,208156,210567,213005,215472,217967,220491,223044,225626,228239,230882,233555,236260,238996,241763,244563,247394,250259,253157,256088,259054,
262054,265088,268158,271263,274404,277581,280795,284047,287336,290663,294029,297434,300878,304362,307886,311451,315058,318706,322396,326129,329906,333726,337590,341499,345454,349454,353500,357594,361735,365923,
370160,374447,378783,383169,387606,392094,396634,401227,405873,410573,415327,420136,425001,429922,434901,439936,445031,450184,455397,460670,466004,471400,476859,482381,487966,493617,499333,505115,510964,516880,
522865,528920,535045,541240,547507,553847,560260,566748,573311,579949,586665,593458,600330,607281,614313,621427,628623,635902,643265,650714,658249,665871,673581,681381,689271,697252,705326,713493,721755,730113,
738567,747119,755771,764522,773375,782330,791389,800553,809823,819200
};

unsigned long gain_lookup[1201]={1,
1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,
2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,
2,2,2,2,2,2,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,
3,3,3,3,3,3,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,5,5,5,
5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,6,6,6,6,6,6,6,6,6,6,6,6,6,6,7,
7,7,7,7,7,7,7,7,7,7,7,7,8,8,8,8,8,8,8,8,8,8,8,9,9,9,9,9,9,9,
9,9,10,10,10,10,10,10,10,10,10,11,11,11,11,11,11,11,11,12,12,12,12,12,12,12,13,13,13,13,
13,13,13,14,14,14,14,14,14,15,15,15,15,15,15,16,16,16,16,16,17,17,17,17,17,18,18,18,18,18,
19,19,19,19,19,20,20,20,20,21,21,21,21,22,22,22,22,23,23,23,23,24,24,24,24,25,25,25,26,26,
26,27,27,27,27,28,28,28,29,29,29,30,30,30,31,31,32,32,32,33,33,33,34,34,35,35,35,36,36,37,
37,37,38,38,39,39,40,40,41,41,42,42,43,43,43,44,45,45,46,46,47,47,48,48,49,49,50,51,51,52,
52,53,54,54,55,55,56,57,57,58,59,59,60,61,61,62,63,64,64,65,66,67,67,68,69,70,71,71,72,73,
74,75,76,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,100,101,102,103,
104,106,107,108,109,111,112,113,114,116,117,118,120,121,123,124,125,127,128,130,131,133,134,136,138,139,141,142,144,146,
147,149,151,153,154,156,158,160,162,163,165,167,169,171,173,175,177,179,181,183,186,188,190,192,194,197,199,201,203,206,
208,211,213,215,218,220,223,226,228,231,234,236,239,242,245,247,250,253,256,259,262,265,268,271,274,278,281,284,287,291,
294,297,301,304,308,311,315,319,322,326,330,334,338,341,345,349,354,358,362,366,370,374,379,383,388,392,397,401,406,411,
415,420,425,430,435,440,445,450,455,461,466,471,477,482,488,494,499,505,511,517,523,529,535,541,548,554,560,567,573,580,
587,593,600,607,614,621,629,636,643,651,658,666,674,681,689,697,705,713,722,730,739,747,756,765,773,782,791,801,810,819,
829,838,848,858,868,878,888,898,909,919,930,941,951,962,974,985,996,1008,1020,1031,1043,1055,1068,1080,1092,1105,1118,1131,1144,1157,
1171,1184,1198,1212,1226,1240,1254,1269,1283,1298,1313,1329,1344,1360,1375,1391,1407,1424,1440,1457,1474,1491,1508,1525,1543,1561,1579,1597,1616,1635,
1653,1673,1692,1712,1731,1751,1772,1792,1813,1834,1855,1877,1898,1920,1943,1965,1988,2011,2034,2058,2082,2106,2130,2155,2180,2205,2230,2256,2282,2309,
2336,2363,2390,2418,2446,2474,2503,2532,2561,2591,2621,2651,2682,2713,2744,2776,2808,2840,2873,2907,2940,2974,3009,3044,3079,3115,3151,3187,3224,3261,
3299,3337,3376,3415,3455,3495,3535,3576,3617,3659,3702,3744,3788,3832,3876,3921,3966,4012,4059,4106,4153,4201,4250,4299,4349,4399,4450,4502,4554,4607,
4660,4714,4769,4824,4880,4936,4993,5051,5110,5169,5229,5289,5350,5412,5475,5538,5603,5667,5733,5799,5867,5935,6003,6073,6143,6214,6286,6359,6433,6507,
6582,6659,6736,6814,6893,6973,7053,7135,7218,7301,7386,7471,7558,7645,7734,7823,7914,8006,8098,8192,
8287,8383,8480,8578,8677,8778,8880,8982,9086,9192,9298,9406,9515,9625,9736,9849,9963,10078,10195,10313,10433,10553,10676,10799,10924,11051,11179,11308,11439,11572,
11705,11841,11978,12117,12257,12399,12543,12688,12835,12983,13134,13286,13440,13595,13753,13912,14073,14236,14401,14568,14736,14907,15080,15254,15431,15610,15790,15973,16158,16345,
16534,16726,16920,17116,17314,17514,17717,17922,18130,18340,18552,18767,18984,19204,19426,19651,19879,20109,20342,20577,20816,21057,21301,21547,21797,22049,22304,22563,22824,23088,
23356,23626,23900,24176,24456,24739,25026,25316,25609,25905,26205,26509,26816,27126,27440,27758,28080,28405,28734,29066,29403,29743,30088,30436,30789,31145,31506,31871,32240,32613,
32991,33373,33759,34150,34545,34945,35350,35759,36173,36592,37016,37445,37878,38317,38761,39209,39663,40123,40587,41057,41533,42014,42500,42992,43490,43994,44503,45018,45540,46067,
46600,47140,47686,48238,48797,49362,49933,50511,51096,51688,52287,52892,53504,54124,54751,55385,56026,56675,57331,57995,58666,59346,60033,60728,61431,62143,62862,63590,64327,65071,
65825,66587,67358,68138,68927,69725,70533,71349,72176,73011,73857,74712,75577,76452,77337,78233,79139,80055,80982,81920,82869,83828,84799,85781,86774,87779,88795,89823,90864,91916,
92980,94057,95146,96248,97362,98490,99630,100784,101951,103131,104325,105533,106755,107992,109242,110507,111787,113081,114391,115715,117055,118410,119782,121169,122572,123991,125427,126879,128348,129834,
131338,132859,134397,135953,137528,139120,140731,142361,144009,145677,147364,149070,150796,152542,154309,156095,157903,159731,161581,163452,165345,167259,169196,171155,173137,175142,177170,179221,181297,183396,
185520,187668,189841,192039,194263,196512,198788,201090,203418,205774,208156,210567,213005,215472,217967,220491,223044,225626,228239,230882,233555,236260,238996,241763,244563,247394,250259,253157,256088,259054,
262054,265088,268158,271263,274404,277581,280795,284047,287336,290663,294029,297434,300878,304362,307886,311451,315058,318706,322396,326129,329906,333726,337590,341499,345454,349454,353500,357594,361735,365923,
370160,374447,378783,383169,387606,392094,396634,401227,405873,410573,415327,420136,425001,429922,434901,439936,445031,450184,455397,460670,466004,471400,476859,482381,487966,493617,499333,505115,510964,516880,
522865,528920,535045,541240,547507,553847,560260,566748,573311,579949,586665,593458,600330,607281,614313,621427,628623,635902,643265,650714,658249,665871,673581,681381,689271,697252,705326,713493,721755,730113,
738567,747119,755771,764522,773375,782330,791389,800553,809823,819200};

void Change_Leveler_Input12(int gain)
{
    unsigned short data;
    if((gain>=-800) && (gain<=400)){
        data = (unsigned short)(gain_lookup[gain+800]&0xffff);
        FPGA_write(fd,25,data);   
        data = (unsigned short)((gain_lookup[gain+800]>>16)&0xffff);
        FPGA_write(fd,26,data);    
    }
}

void Change_Comp_Input12(int gain)
{
    unsigned short data;
    if((gain>=-800) && (gain<=400)){
        data = (unsigned short)(gain_lookup[gain+800]&0xffff);
        FPGA_write(fd,28,data);   
        data = (unsigned short)((gain_lookup[gain+800]>>16)&0xffff);
        FPGA_write(fd,29,data);    
    }
}
//extern
void Change_Delay_Audio(int fd,long delay)
{
    Change_Delay(fd,delay*48);
}
void Change_Delay(int fd,unsigned long delay)
{
    unsigned short data;
    data = (unsigned short)(delay&0xffff);
    FPGA_write(fd,35,data);
    data = (unsigned short)((delay>>16)&0xffff);
    FPGA_write(fd,36,data);
    
}
//Functions
// Thay doi volume tu -80dBFS -> 40dBFS, gain chay tu -80 den 40
void Change_Gain_Full_CH12(int fd,double gain)
{
    unsigned short data;
    int i;
    double c_gain;
    c_gain = (gain+80)*10;    
    i = (int)c_gain;        
    data = (unsigned short)(gain_lookup[i]&0xffff);
    FPGA_write(fd,23,data);   
    data = (unsigned short)((gain_lookup[i]>>16)&0xffff);
    FPGA_write(fd,24,data);    
    
}


//Functions
// Thay doi volume tu 0dBFS -> 40dBFS, gain chay tu 0 den 399.
void Change_GainCH12(int fd,int gain)
{
    unsigned short data;
    
    data = (unsigned short)(gain_lkup[gain]&0xffff);
    FPGA_write(fd,23,data);   
    data = (unsigned short)((gain_lkup[gain]>>16)&0xffff);
    FPGA_write(fd,24,data);    
}

//------------------------------------------------------------------------------

void Comp_GainCH12(int fd,int gain)
{
    unsigned short data;
    int my_gain;
    
    
    my_gain=gain;    
    if(my_gain>=800)
        my_gain=800;
    if(my_gain<0)
        my_gain=0;
    my_gain=800-my_gain;
    
    data = (unsigned short)(min_gain_lk[my_gain]&0xffff);
    FPGA_write(fd,30,data);   
    data = (unsigned short)((min_gain_lk[my_gain]>>16)&0xffff);
    FPGA_write(fd,31,data);    
}
